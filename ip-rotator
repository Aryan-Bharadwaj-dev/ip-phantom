#!/bin/bash

# IP Rotator - Cybersecurity Tool for Automated IP Address Changing
# Bash wrapper script for the Python IP rotator
# For educational and legitimate security testing purposes only

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine if we're running from global installation or local directory
if [[ "$SCRIPT_DIR" == "/usr/local/bin" ]] || [[ "$SCRIPT_DIR" == "/usr/bin" ]]; then
    # Global installation - find the actual script directory
    REAL_SCRIPT="$(readlink "${BASH_SOURCE[0]}")"
    SCRIPT_DIR="$(cd "$(dirname "$REAL_SCRIPT")" && pwd)"
fi

PYTHON_SCRIPT="$SCRIPT_DIR/ip_rotator.py"
DEFAULT_INTERVAL=3
DEFAULT_CONFIG="$SCRIPT_DIR/config.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
print_banner() {
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "    ██╗██████╗     ██████╗  ██████╗ ████████╗ █████╗ ████████╗ ██████╗ ██████╗ "
    echo "    ██║██╔══██╗    ██╔══██╗██╔═══██╗╚══██╔══╝██╔══██╗╚══██╔══╝██╔═══██╗██╔══██╗"
    echo "    ██║██████╔╝    ██████╔╝██║   ██║   ██║   ███████║   ██║   ██║   ██║██████╔╝"
    echo "    ██║██╔═══╝     ██╔══██╗██║   ██║   ██║   ██╔══██║   ██║   ██║   ██║██╔══██╗"
    echo "    ██║██║         ██║  ██║╚██████╔╝   ██║   ██║  ██║   ██║   ╚██████╔╝██║  ██║"
    echo "    ╚═╝╚═╝         ╚═╝  ╚═╝ ╚═════╝    ╚═╝   ╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝"
    echo ""
    echo "                    Cybersecurity IP Address Rotation Tool"
    echo "                    For Educational & Security Testing Purposes"
    echo "=================================================================="
    echo -e "${NC}"
}

# Help function
show_help() {
    # Detect if running from global installation or local
    # Check how this script was actually called
    SCRIPT_NAME="$(basename "$0")"
    if [[ "$SCRIPT_NAME" == "ip-rotator" ]] && [[ "$0" != "./ip-rotator" ]]; then
        COMMAND="ip-rotator"
        INSTALL_STATUS="🌍 Global Installation"
    else
        COMMAND="./ip-rotator"
        INSTALL_STATUS="📁 Local Installation"
    fi
    
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "                    🎯 IP ROTATOR HELP GUIDE"
    echo "=================================================================="
    echo -e "${NC}"
    echo -e "${GREEN}IP Rotator - Professional Cybersecurity IP Rotation Tool${NC}"
    echo -e "${BLUE}$INSTALL_STATUS${NC}"
    echo ""
    echo -e "${YELLOW}📋 USAGE:${NC}"
    echo "  $COMMAND [OPTIONS]"
    echo ""
    echo -e "${YELLOW}⚙️  CORE OPTIONS:${NC}"
    echo "  -i, --interval SECONDS    ⏱️  Time interval between rotations (default: 3)"
    echo "  -c, --config FILE         📁 Configuration file path (default: config.json)"
    echo "  -v, --verbose             📊 Enable verbose logging output"
    echo "  -h, --help               ❓ Show this comprehensive help message"
    echo ""
    echo -e "${YELLOW}🔧 UTILITY COMMANDS:${NC}"
    echo "  --check-ip               📍 Check current IP address and exit"
    echo "  --setup                  🛠️  Run interactive setup wizard"
    echo "  --stop                   🛑 Stop all running VPN connections"
    echo "  --demo                   🎯 Run in demo mode (simulated IP changes)"
    echo ""
    echo -e "${YELLOW}✨ QUICK START EXAMPLES:${NC}"
    echo -e "  ${GREEN}# 🎯 Demo Mode - Perfect for presentations!${NC}"
    echo "  $COMMAND --demo --interval 5"
    echo ""
    echo -e "  ${GREEN}# 🚀 Basic Operations${NC}"
    echo "  $COMMAND --check-ip              # Check current IP"
    echo "  $COMMAND --interval 10           # Rotate every 10 seconds"
    echo "  $COMMAND --setup                 # Initial configuration"
    echo ""
    echo -e "  ${GREEN}# 🔧 Advanced Usage${NC}"
    echo "  $COMMAND --config my_vpns.json --verbose  # Custom config + logging"
    echo "  $COMMAND --demo --verbose --interval 3    # Verbose demo mode"
    echo ""
    echo -e "${YELLOW}🎯 DEMO MODE FEATURES:${NC}"
    echo "  ✅ Zero dependencies - no VPN setup required"
    echo "  ✅ Perfect for cybersecurity demonstrations"
    echo "  ✅ Safe simulated IP rotation"
    echo "  ✅ Professional visual output with emojis"
    echo "  ✅ Instant Ctrl+C response for clean shutdown"
    echo ""
    echo -e "${YELLOW}📋 SYSTEM REQUIREMENTS:${NC}"
    echo -e "  ${GREEN}For Demo Mode:${NC}"
    echo "  - Python 3.6+ 🐍"
    echo "  - curl (for IP checking) 🌐"
    echo ""
    echo -e "  ${GREEN}For Production Mode:${NC}"
    echo "  - All demo requirements plus:"
    echo "  - OpenVPN client 🔒"
    echo "  - VPN configuration files (.ovpn) 📄"
    echo "  - sudo privileges (for VPN operations) 👑"
    echo ""
    if [[ "$COMMAND" == "./ip-rotator" ]]; then
        echo -e "${YELLOW}🚀 INSTALLATION TIP:${NC}"
        echo -e "  ${GREEN}Make globally available (run once):${NC}"
        echo "  ./install.sh"
        echo "  # Then use: ip-rotator --demo (from anywhere!)"
    else
        echo -e "${YELLOW}🎉 GLOBAL INSTALLATION ACTIVE:${NC}"
        echo -e "  ${GREEN}You're using the global installation! Benefits:${NC}"
        echo "  ✅ Run from any directory"
        echo "  ✅ No need for ./"
        echo "  ✅ Professional workflow"
    fi
    echo ""
    echo -e "${YELLOW}🔍 TROUBLESHOOTING:${NC}"
    echo -e "  ${GREEN}Test basic functionality:${NC}"
    echo "  $COMMAND --demo --check-ip       # Test without VPN"
    echo "  $COMMAND --demo --verbose        # Debug with details"
    echo ""
    echo -e "  ${GREEN}Permission issues:${NC}"
    if [[ "$COMMAND" == "./ip-rotator" ]]; then
        echo "  chmod +x ip-rotator ip_rotator.py   # Fix permissions"
    else
        echo "  cd $(readlink $(which ip-rotator) | xargs dirname)  # Go to source"
        echo "  chmod +x ip-rotator ip_rotator.py   # Fix permissions"
    fi
    echo ""
    echo -e "${RED}⚠️  LEGAL DISCLAIMER:${NC}"
    echo -e "This tool is for ${YELLOW}educational and authorized security testing only${NC}."
    echo "Users are responsible for compliance with applicable laws and regulations."
    echo "Always obtain proper authorization before testing any systems."
    echo ""
    echo -e "${BLUE}==================================================================${NC}"
}

# Check dependencies
check_dependencies() {
    local missing_deps=()
    
    # Check Python
    if ! command -v python3 &> /dev/null; then
        missing_deps+=("python3")
    fi
    
    # Check OpenVPN
    if ! command -v openvpn &> /dev/null; then
        missing_deps+=("openvpn")
    fi
    
    # Check curl
    if ! command -v curl &> /dev/null; then
        missing_deps+=("curl")
    fi
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo -e "${RED}Error: Missing required dependencies:${NC}"
        for dep in "${missing_deps[@]}"; do
            echo "  - $dep"
        done
        echo ""
        echo "Please install the missing dependencies and try again."
        exit 1
    fi
}

# Setup wizard
setup_wizard() {
    echo -e "${GREEN}IP Rotator Setup Wizard${NC}"
    echo "==============================="
    echo ""
    
    # Check if already configured
    if [ -f "$DEFAULT_CONFIG" ]; then
        echo -e "${YELLOW}Configuration file already exists: $DEFAULT_CONFIG${NC}"
        read -p "Do you want to overwrite it? (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Setup cancelled."
            exit 0
        fi
    fi
    
    echo "This wizard will help you configure VPN servers for IP rotation."
    echo ""
    echo -e "${YELLOW}Prerequisites:${NC}"
    echo "1. OpenVPN configuration files (.ovpn) from your VPN provider"
    echo "2. VPN credentials (if required)"
    echo "3. Sudo privileges"
    echo ""
    
    read -p "Do you have OpenVPN configuration files ready? (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${YELLOW}Please obtain OpenVPN configuration files first:${NC}"
        echo "1. Sign up with a VPN provider (ExpressVPN, NordVPN, etc.)"
        echo "2. Download OpenVPN configuration files"
        echo "3. Place them in a secure directory"
        echo "4. Re-run this setup"
        exit 0
    fi
    
    # Create default config by running Python script
    echo ""
    echo "Creating default configuration..."
    python3 "$PYTHON_SCRIPT" --check-ip > /dev/null 2>&1
    
    echo -e "${GREEN}✓ Default configuration created: $DEFAULT_CONFIG${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo "1. Edit $DEFAULT_CONFIG"
    echo "2. Update VPN configuration file paths"
    echo "3. Test with: ./ip-rotator --check-ip"
    echo "4. Start rotating: ./ip-rotator --interval 10"
}

# Stop all VPN connections
stop_vpn() {
    echo -e "${YELLOW}Stopping all VPN connections...${NC}"
    
    # Kill OpenVPN processes
    sudo pkill -f openvpn 2>/dev/null
    
    # Reset DNS
    if command -v systemctl &> /dev/null; then
        sudo systemctl restart systemd-resolved 2>/dev/null
    fi
    
    echo -e "${GREEN}✓ VPN connections stopped${NC}"
}

# Check if running as root
check_root() {
    if [[ $EUID -eq 0 ]]; then
        echo -e "${RED}Warning: Running as root is not recommended.${NC}"
        echo "This tool will request sudo privileges when needed."
        read -p "Continue anyway? (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# Main function
main() {
    # Parse arguments
    interval="$DEFAULT_INTERVAL"
    config="$DEFAULT_CONFIG"
    verbose=""
    check_ip=""
    setup=""
    stop=""
    demo=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -i|--interval)
                interval="$2"
                shift 2
                ;;
            -c|--config)
                config="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose="--verbose"
                shift
                ;;
            --check-ip)
                check_ip="--check-ip"
                shift
                ;;
            --setup)
                setup=true
                shift
                ;;
            --stop)
                stop=true
                shift
                ;;
            --demo)
                demo="--demo"
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}Error: Unknown option $1${NC}"
                echo "Use --help for usage information."
                exit 1
                ;;
        esac
    done
    
    # Show banner
    print_banner
    
    # Handle special commands
    if [[ "$setup" == true ]]; then
        setup_wizard
        exit 0
    fi
    
    if [[ "$stop" == true ]]; then
        stop_vpn
        exit 0
    fi
    
    # Check dependencies (skip OpenVPN check for demo mode)
    if [[ "$demo" != "--demo" ]]; then
        check_dependencies
    else
        # Only check Python and curl for demo mode
        if ! command -v python3 &> /dev/null; then
            echo -e "${RED}Error: Missing required dependency: python3${NC}"
            exit 1
        fi
        if ! command -v curl &> /dev/null; then
            echo -e "${RED}Error: Missing required dependency: curl${NC}"
            exit 1
        fi
    fi
    
    # Check if not running as root
    check_root
    
    # Check if Python script exists
    if [[ ! -f "$PYTHON_SCRIPT" ]]; then
        echo -e "${RED}Error: Python script not found: $PYTHON_SCRIPT${NC}"
        exit 1
    fi
    
    # Security: Validate and sanitize interval
    if [[ ! "$interval" =~ ^[0-9]+$ ]] || [[ "$interval" -lt 1 ]] || [[ "$interval" -gt 86400 ]]; then
        echo -e "${RED}Error: Interval must be a positive integer between 1 and 86400 seconds${NC}"
        exit 1
    fi
    
    # Security: Validate config file path
    if [[ "$config" == *".."* ]] || [[ "$config" == *"/"* && "$config" != "$DEFAULT_CONFIG" ]]; then
        # Only allow relative paths or default config for security
        config="$(basename "$config")"
        echo -e "${YELLOW}Security: Using sanitized config filename: $config${NC}"
    fi
    
    # Security: Build command with array to prevent injection
    python_args=("$PYTHON_SCRIPT" "--interval" "$interval" "--config" "$config")
    
    if [[ -n "$verbose" ]]; then
        python_args+=("--verbose")
    fi
    
    if [[ -n "$check_ip" ]]; then
        python_args+=("--check-ip")
    fi
    
    if [[ -n "$demo" ]]; then
        python_args+=("--demo")
    fi
    
    # Show configuration
    if [[ -z "$check_ip" ]]; then
        echo -e "${GREEN}Configuration:${NC}"
        echo "  Interval: ${interval}s"
        echo "  Config: $config"
        echo "  Script: $PYTHON_SCRIPT"
        echo ""
        echo -e "${YELLOW}Starting IP rotation...${NC}"
        echo "Press Ctrl+C to stop"
        echo ""
    fi
    
    # Security: Execute Python script with array expansion to prevent injection
    exec python3 "${python_args[@]}"
}

# Run main function
main "$@"
